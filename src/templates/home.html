{% extends "base.html" %}
{% block title %}Inicio - Sistema de Planos{% endblock %}

{% block content %}
<!-- 🔑 Solo mostrar el botón si el usuario tiene rol ADMIN o EDITOR -->
{% if current_user.is_authenticated and current_user.rol in ["admin", "editor"] %}
<div class="flex gap-4 mb-4">
    <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hover:scale-105 transition-all"
        onclick="document.getElementById('modalAgregar').classList.remove('hidden')">
        Agregar Nuevo Documento
    </button>
</div>
{% endif %}

<!-- 🔍 Formulario de búsqueda -->
<form class="bg-white p-6 rounded shadow mb-8 flex flex-wrap gap-4 items-end" method="get"
    action="{{ url_for('home') }}">
    <div>
        <label class="block text-sm font-medium mb-1">Fecha</label>
        <input type="text" name="fecha" class="border rounded px-2 py-1 w-40" placeholder="YYYY-MM-DD">
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Descripción</label>
        <input type="text" name="descripcion" class="border rounded px-2 py-1 w-40" placeholder="Descripción">
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Identificador de Plano</label>
        <input type="text" name="identificador_plano" class="border rounded px-2 py-1 w-32" placeholder="Identificador">
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Tamaño</label>
        <select name="tamano" class="border rounded px-2 py-1 w-46">
            <option value="" disabled selected>Selecciona tamaño</option>
            <option value="0">A0</option>
            <option value="1">A1</option>
            <option value="2">A2</option>
            <option value="3">A3</option>
            <option value="4">A4</option>
        </select>
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Revision</label>
        <select name="revision" class="border rounded px-2 py-1 w-full">
            <option value="">Seleccionar Revision</option>
            <option value="_">_</option>
            <option value="Z">Z</option>
            <option value="Y">Y</option>
            <option value="X">X</option>
            <option value="W">W</option>
            <option value="V">V</option>
            <option value="U">U</option>
            <option value="T">T</option>
            <option value="S">S</option>
            <option value="R">R</option>
            <option value="Q">Q</option>
            <option value="P">P</option>
            <option value="O">O</option>
            <option value="N">N</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="K">K</option>
            <option value="J">J</option>
            <option value="I">I</option>
            <option value="H">H</option>
            <option value="G">G</option>
            <option value="F">F</option>
            <option value="E">E</option>
            <option value="D">D</option>
            <option value="C">C</option>
            <option value="B">B</option>
            <option value="A">A</option>
        </select>
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Sub-revision</label>
        <select id="sub_revision" name="sub_revision" class="border rounded px-2 py-1 w-full">
            <option value=" ">Ninguno</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
        </select>
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">Nombre del Dibujante</label>
        <input type="text" name="dibujante" class="border rounded px-2 py-1 w-40" placeholder="Dibujante">
    </div>
    <div class="flex gap-2">
        <button type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 hover:scale-105 transition-all">Buscar</button>
        <button type="reset"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 hover:scale-105 transition-all">Limpiar</button>
    </div>
</form>

<!-- 📋 Tabla de resultados -->
<div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded shadow">
        <thead>
            <tr class="bg-gray-200 text-gray-700">
                <th class="px-4 py-2">Fecha</th>
                <th class="px-4 py-2">Descripción</th>
                <th class="px-4 py-2">Identificador de Plano</th>
                <th class="px-4 py-2">Tamaño</th>
                <th class="px-4 py-2">Revision</th>
                <th class="px-4 py-2">Sub-revision</th>
                <th class="px-4 py-2">Nombre del Dibujante</th>
                <th class="px-4 py-2">Ver</th>
                <th class="px-4 py-2">Descargar</th>
                <th class="px-4 py-2">Operaciones</th>
            </tr>
        </thead>
        <tbody>
            {% for d in data %}
            <tr>
                <td class="border px-4 py-2">{{ d.fecha }}</td>
                <td class="border px-4 py-2">{{ d.descripcion }}</td>
                <td class="border px-4 py-2">{{ d.identificador_plano }}</td>
                <td class="border px-4 py-2">A{{ d.tamanio }}</td>
                <td class="border px-4 py-2">{{ d.revision }}</td>
                <td class="border px-4 py-2">{{ d.sub_revision }}</td>
                <td class="border px-4 py-2">{{ d.dibujante }}</td>
                <td class="border px-4 py-2 text-center">
                    {% if d.archivo_token %}
                    <a href="{{ url_for('view_file', token=d.archivo_token) }}" target="_blank"
                        class="text-blue-600 underline">Ver</a>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="border px-4 py-2 text-center">
                    {% if d.archivo_token %}
                    <a href="{{ url_for('download_file', token=d.archivo_token) }}"
                        class="text-green-600 underline">Descargar</a>
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="border px-4 py-2 text-center">
                    <!-- 🔑 Solo mostrar si el usuario tiene permisos -->
                    {% if current_user.is_authenticated and current_user.rol in ["admin", "editor"] %}
                    <button
                        class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 hover:scale-105 transition-all"
                        onclick="document.getElementById('modal{{ d.id_registro }}').classList.remove('hidden')">
                        Editar
                    </button>
                    <button
                        class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700 hover:scale-105 transition-all"
                        onclick="document.getElementById('modalReutilizar{{ d.id_registro }}').classList.remove('hidden')">
                        Reutilizar
                    </button>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.rol == "admin" %}
                    <button
                        class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 hover:scale-105 transition-all"
                        onclick="document.getElementById('modalEliminar{{ d.id_registro }}').classList.remove('hidden')">
                        Eliminar
                    </button>
                    {% endif %}
                </td>
            </tr>

            <!-- Aquí van los modales: modalAgregar, modalEditar, modalReutilizar, modalEliminar -->
            {% include "partials/modal_agregar.html" %}
            {% include "partials/modal_editar.html" %}
            {% include "partials/modal_reutilizar.html" %}
            {% include "partials/modal_eliminar.html" %}
            {% include "partials/modal_registrar_usuarios.html" %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    const identificadoresExistentes = JSON.parse('{{ lista_identificadores | tojson | safe }}');
</script>
{% endblock %}